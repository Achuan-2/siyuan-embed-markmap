<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markmap ç¼–è¾‘å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    /* å®¹å™¨å¸ƒå±€ */
    .container {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    /* å·¦ä¾§ç¼–è¾‘å™¨ */
    .editor-panel {
      width: 40%;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #e0e0e0;
      background-color: #f5f5f5;
    }

    .editor-header {
      padding: 15px 20px;
      background-color: #fff;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-header h2 {
      font-size: 18px;
      color: #333;
    }

    .editor-header .info {
      font-size: 12px;
      color: #666;
    }

    #markdown-input {
      flex: 1;
      padding: 20px;
      border: none;
      outline: none;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      background-color: #fff;
    }

    /* å³ä¾§é¢„è§ˆ */
    .preview-panel {
      width: 60%;
      position: relative;
      background-color: #fafafa;
    }

    .preview-header {
      padding: 15px 20px;
      background-color: #fff;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preview-header h2 {
      font-size: 18px;
      color: #333;
    }

    #mindmap {
      width: 100%;
      height: calc(100% - 60px);
    }



    /* æŒ‰é’®æ ·å¼ */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
      margin-left: 10px;
    }

    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background-color: #45a049;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
      background-color: #2196F3;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #0b7dda;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* åˆ†éš”æ  */
    .resize-handle {
      position: absolute;
      left: 40%;
      top: 0;
      width: 4px;
      height: 100%;
      cursor: col-resize;
      background-color: #e0e0e0;
      z-index: 1000;
      transition: background-color 0.2s;
    }

    .resize-handle:hover,
    .resize-handle.active {
      background-color: #2196F3;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .editor-panel,
      .preview-panel {
        width: 100% !important;
      }

      .editor-panel {
        height: 40%;
        border-right: none;
        border-bottom: 2px solid #e0e0e0;
      }

      .preview-panel {
        height: 60%;
      }

      .resize-handle {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- å·¦ä¾§ç¼–è¾‘å™¨ -->
    <div class="editor-panel">
      <div class="editor-header">
        <h2>ğŸ“ Markdown ç¼–è¾‘å™¨</h2>
        <span class="info">å®æ—¶é¢„è§ˆ</span>
      </div>
      <textarea id="markdown-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥ Markdown..."># æ€ç»´å¯¼å›¾ç¤ºä¾‹

## å‰ç«¯æŠ€æœ¯æ ˆ

### JavaScript
- ES6+
- TypeScript
- å¼‚æ­¥ç¼–ç¨‹

### æ¡†æ¶
- React
- Vue
- Angular

### å·¥å…·é“¾
- Webpack
- Vite
- Babel

## åç«¯æŠ€æœ¯

### Node.js
- Express
- Koa
- NestJS

### æ•°æ®åº“
- MySQL
- MongoDB
- Redis

## DevOps

### å®¹å™¨åŒ–
- Docker
- Kubernetes

### CI/CD
- Jenkins
- GitHub Actions
- GitLab CI</textarea>
    </div>

    <!-- å¯æ‹–åŠ¨çš„åˆ†éš”æ  -->
    <div class="resize-handle"></div>

    <!-- å³ä¾§é¢„è§ˆ -->
    <div class="preview-panel">
      <div class="preview-header">
        <h2>ğŸ—ºï¸ æ€ç»´å¯¼å›¾é¢„è§ˆ</h2>
        <div>
          <button class="btn btn-secondary" onclick="fitView()">ğŸ“ é€‚åº”çª—å£</button>
          <button class="btn btn-primary" onclick="exportSVG()">ğŸ“¥ å¯¼å‡º SVG</button>
        </div>
      </div>
      <svg id="mindmap"></svg>
    </div>
  </div>

  <script src="https://unpkg.com/markmap-lib@0.14.4/dist/browser/index.min.js"></script>
  <script src="https://unpkg.com/d3@6.7.0/dist/d3.min.js"></script>
  <script src="https://unpkg.com/markmap-view@0.14.4/dist/index.min.js"></script>

  <script>
    const { markmap } = window;
    const { Markmap, loadCSS, loadJS, Transformer } = markmap;
    const transformer = new Transformer();

    let markmapInstance = null;
    const options = {
      duration: 0, // ç¦ç”¨åŠ¨ç”»
      maxWidth: 300,
      nodeMinHeight: 16,
      spacingVertical: 5,
      spacingHorizontal: 80,
      paddingX: 8
    };

    // åˆå§‹åŒ– markmap
    function initMarkmap(markdown) {
      const { root, features } = transformer.transform(markdown);
      const { styles, scripts } = transformer.getUsedAssets(features);
      
      if (styles) loadCSS(styles);
      if (scripts) loadJS(scripts, { getMarkmap: () => markmap });
      
      markmapInstance = Markmap.create("#mindmap", options, root);
    }

    // åªæ›´æ–°å˜åŒ–çš„å†…å®¹
    function updateContent(newMarkdown) {
      if (!markmapInstance) {
        initMarkmap(newMarkdown);
        return;
      }
      
      try {
        const { root } = transformer.transform(newMarkdown);
        markmapInstance.setData(root);
        markmapInstance.fit(); // è‡ªåŠ¨é€‚åº”è§†å›¾
      } catch (error) {
        console.error('æ›´æ–°å¤±è´¥:', error);
      }
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ç›‘å¬è¾“å…¥å˜åŒ–
    const markdownInput = document.getElementById('markdown-input');
    const debouncedUpdate = debounce((value) => {
      updateContent(value);
    }, 300);

    markdownInput.addEventListener('input', (e) => {
      debouncedUpdate(e.target.value);
    });

    // åˆå§‹åŒ–
    initMarkmap(markdownInput.value);

    // é€‚åº”çª—å£
    function fitView() {
      if (markmapInstance) {
        markmapInstance.fit();
      }
    }

    // å¯¼å‡º SVG
    function exportSVG() {
      try {
        const svgElement = document.getElementById('mindmap');
        const clonedSvg = svgElement.cloneNode(true);
        
        const bbox = svgElement.getBBox();
        clonedSvg.setAttribute('viewBox', `${bbox.x - 20} ${bbox.y - 20} ${bbox.width + 40} ${bbox.height + 40}`);
        clonedSvg.setAttribute('width', bbox.width + 40);
        clonedSvg.setAttribute('height', bbox.height + 40);
        clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        clonedSvg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
        
        // å†…è”æ ·å¼
        const styles = Array.from(document.styleSheets)
          .filter(sheet => {
            try {
              return sheet.cssRules;
            } catch (e) {
              return false;
            }
          })
          .reduce((acc, sheet) => {
            return acc + Array.from(sheet.cssRules).map(rule => rule.cssText).join('\n');
          }, '');
        
        const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
        styleElement.textContent = styles;
        clonedSvg.insertBefore(styleElement, clonedSvg.firstChild);
        
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(clonedSvg);
        const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `markmap-${Date.now()}.svg`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log('âœ… SVG å¯¼å‡ºæˆåŠŸï¼');
      } catch (error) {
        console.error('âŒ å¯¼å‡º SVG å¤±è´¥:', error);
        alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
      }
    }

    // å¯æ‹–åŠ¨åˆ†éš”æ 
    const resizeHandle = document.querySelector('.resize-handle');
    const editorPanel = document.querySelector('.editor-panel');
    const previewPanel = document.querySelector('.preview-panel');
    let isResizing = false;

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      resizeHandle.classList.add('active');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      
      const containerWidth = document.querySelector('.container').offsetWidth;
      const newLeftWidth = (e.clientX / containerWidth) * 100;
      
      if (newLeftWidth > 20 && newLeftWidth < 80) {
        editorPanel.style.width = `${newLeftWidth}%`;
        previewPanel.style.width = `${100 - newLeftWidth}%`;
        resizeHandle.style.left = `${newLeftWidth}%`;
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        resizeHandle.classList.remove('active');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // è°ƒæ•´å¤§å°åé‡æ–°é€‚åº”è§†å›¾
        setTimeout(() => fitView(), 100);
      }
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + S: å¯¼å‡º
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        exportSVG();
      }
      // Ctrl/Cmd + E: é€‚åº”çª—å£
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        fitView();
      }
    });
  </script>
</body>

</html>
